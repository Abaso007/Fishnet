<div class="card">
    <div class="card-header">
        <div class="card-head-row">
            <div class="card-title">Attack options</div>
        </div>
    </div>
    <div class="card-body" id="options-content">
        <div class="row mt-2">
            {% for option, data in options %}
            {% if option == 'PAYLOAD' %}
            <div class="col-md-4">
                <div class="form-group form-group-default">
                    <label>
                        {{ option }}
                    </label>
                    <select class="form-control" id="{{ option }}" name="{{ option }}"
                            onchange="addPayloadOptions('{{ option }}', this.value);">
                        {% if value is not None %}
                        <option value="{{ data.0 }}" selected>{{ data.0 }}</option>
                        {% for payload in all_payloads %}
                        <option value="{{ payload }}">{{ payload }}</option>
                        {% endfor %}
                        {% else %}
                        <option value="" selected disabled hidden>Select payload</option>
                        {% for payload in all_payloads %}
                        <option value="{{ payload }}">{{ payload }}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>
            {% else %}
            {% if data.0 == 'yes' or data.0 == 'no' %}
            <div class="col-md-4">
                <div class="form-group form-group-default">
                    <label>
                        {{ option }}
                    </label>
                    <select class="form-control" id="{{ option }}" name="{{ option }}"
                            onchange="addPayloadOptions('{{ option }}', this.value);">
                        <option value="{{ data.0 }}" selected>{{ data.0 }}</option>
                        {% if data.0 == 'yes' %}
                        <option value="no">no</option>
                        {% else %}
                        <option value="yes">yes</option>
                        {% endif %}
                    </select>
                </div>
            </div>
            {% else %}
            <div class="col-md-4">
                <div class="form-group form-group-default">
                    <label>
                        {{ option }}
                    </label>
                    <input class="form-control" id="{{ option }}" name="{{ option }}" placeholder="{{ option }}" type="text"
                           value="{% if data.0 is not None %}{{ data.0 }}{% endif %}"
                           onchange="setFlawOption('{{ request.path }}', '{{ current_flaw }}', '{{ option }}', this.value);">
                </div>
            </div>
            {% endif %}
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="card-head-row">
            <div class="card-title">Attack log</div>
            <div class="card-tools">
                <button id="attack-image" class="btn btn-info btn-border btn-round btn-sm">
                    <span class="btn-label">
                        <i class="fa fa-file-export mr-2"></i>
                    </span>
                    Export
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row mt-2">
            <div class="col-md-12">
                <div class="form-group" id="attack-log"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-footer no-bd">
    <button class="btn btn-success" onclick="executeAttack('{{ request.path }}');" type="button">Execute</button>
</div>

<script>
$('#attack-image').on('click', function() {
    html2canvas(document.querySelector("#attack-log")).then(canvas => {
        var link = document.createElement("a");
        document.body.appendChild(link);
        link.download = "attack.png";
        link.href = canvas.toDataURL();
        link.target = '_blank';
        link.click();
    });
});

function addPayloadOptions(option, value) {
    setFlawOption('{{ request.path }}', '{{ current_flaw }}', option, value);
    fillAttackDetails('{{ request.path }}', '{{ current_flaw }}', '', '');
}

function executeAttack(url) {
    {% if current_flaw %}
    if (url) {
        data = '<center><i class="fa fa-cog fa-4x fa-spin"></i></center>'
        $('#attack-log').html(data);

        $.ajax(url, {
            type: 'POST',
            data: {
                attack: '{{ current_flaw }}',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(data) {
                $('#attack-log').html(data);
            }
        });
    } else {
        $('#attack-log').html('');
    }
    {% endif %}
}
</script>
